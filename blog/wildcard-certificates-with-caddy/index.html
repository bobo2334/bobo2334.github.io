<!doctype html>
<html lang="zh-cn" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="我的学习笔记 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="我的学习笔记 Atom Feed">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" integrity="sha384-Um5gpz1odJg5Z4HAmzPtgZKdTBHZdw8S29IecapCSB31ligYPhHQZMIlWLYQGVoc" crossorigin="anonymous">
<link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180">
<link rel="icon" href="/favicon-32x32.png" sizes="32x32" type="image/png">
<link rel="icon" href="/favicon-16x16.png" sizes="16x16" type="image/png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><title data-react-helmet="true">使用 Caddy 自动申请泛域名证书 | 我的学习笔记</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://iuok.me/blog/wildcard-certificates-with-caddy"><meta data-react-helmet="true" name="docusaurus_locale" content="zh-cn"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" name="msapplication-TileColor" contnet="#da532c"><meta data-react-helmet="true" name="theme-color" contnet="#25c2a0"><meta data-react-helmet="true" property="og:title" content="使用 Caddy 自动申请泛域名证书 | 我的学习笔记"><meta data-react-helmet="true" name="description" content="泛域名证书"><meta data-react-helmet="true" property="og:description" content="泛域名证书"><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2022-01-22T00:00:00.000Z"><meta data-react-helmet="true" property="article:tag" content="caddy"><link data-react-helmet="true" rel="icon" href="/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://iuok.me/blog/wildcard-certificates-with-caddy"><link data-react-helmet="true" rel="alternate" href="https://iuok.me/blog/wildcard-certificates-with-caddy" hreflang="zh-cn"><link data-react-helmet="true" rel="alternate" href="https://iuok.me/blog/wildcard-certificates-with-caddy" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.a4b7a038.css">
<link rel="preload" href="/assets/js/runtime~main.774cf4ed.js" as="script">
<link rel="preload" href="/assets/js/main.1ec4401a.js" as="script">
</head>
<body>
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/android-chrome-512x512.png" alt="Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/android-chrome-512x512.png" alt="Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">我的学习笔记</b></a><a class="navbar__item navbar__link" href="/docs/bookmarks/interesting-projects">笔记</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog/">文章</a><a class="navbar__item navbar__link" href="/blog/archive">文章归档</a><a class="navbar__item navbar__link" href="/blog/tags">文章标签</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/bobo2334/bobo2334.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">🌜</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">🌞</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">最新文章</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/reload-caddyfile-gracefully">优雅地重载 Caddyfile</a></li><li class="sidebarItem_CF0Q"><a aria-current="page" class="sidebarItemLink_miNk sidebarItemLinkActive_RRTD" href="/blog/wildcard-certificates-with-caddy">使用 Caddy 自动申请泛域名证书</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/mount-tencent-cos-on-local-file-system">挂载腾讯云 COS 到本地文件夹</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/activate-windows-and-office-with-kms">用 KMS 激活 Windows 和 Office</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/self-hosted-zerotier-controller">自建 Zerotier 行星节点</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_rzP5" itemprop="headline">使用 Caddy 自动申请泛域名证书</h1><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-01-22T00:00:00.000Z" itemprop="datePublished">2022年1月22日</time></div></header><div id="post-content" class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_mojV" id="泛域名证书">泛域名证书<a class="hash-link" href="#泛域名证书" title="Direct link to heading">​</a></h2><p>在 Caddy 中书写 Matcher 时可以使用通配符，如<code>*.example.com</code>，Caddy 会自动为你申请泛域名证书，但是需要合适的配置。</p><p><code>*.example.com</code>包括<code>foo.example.com</code>、<code>bar.example.com</code>等其它二级域名，但是不包括顶级域名<code>example.com</code>；同时不包括其它等级的域名，只包括同等级域名。</p><p>通配符<code>*</code>只能放在最左边，如<code>*.example.com</code>、<code>*.foo.example.com</code>和<code>*.bar.example.com</code>等；不能写为<code>foo.*.example.com</code>。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="需要做的事情">需要做的事情<a class="hash-link" href="#需要做的事情" title="Direct link to heading">​</a></h2><p>不像单域名证书可以使用文件验证的方式来完成申请，泛域名证书要求 DNS 验证，这要求你得有权限修改该域名的 DNS 记录，并且你的 DNS 服务商要被 Caddy 支持才可以。</p><p>Caddy 对 DNS 的修改功能是由 Caddy 的 DNS 模组实现的，使用模组可以很方便地扩展 Caddy。你可以在 caddy-dns 的仓库列表 <sup id="fnref-1"><a href="#fn-1" class="footnote-ref">1</a></sup> 中查看你的 DNS 服务商是否受支持。</p><p>Caddy 的官方 Docker 镜像 <sup id="fnref-2"><a href="#fn-2" class="footnote-ref">2</a></sup> 并不包括任何模组，只有原版的 Caddy，如果需要使用带模组的镜像话需要自己构建。Caddy 提供了 xcaddy<sup id="fnref-3"><a href="#fn-3" class="footnote-ref">3</a></sup> 工具来帮助你编译带模组的 Caddy，并且也提供了使用示例 <sup id="fnref-2"><a href="#fn-2" class="footnote-ref">2</a></sup>，参考这些说明可以很方便地构建自己的 Caddy 镜像。</p><p>下文中记录了我用过的两个 DNS 服务商模组，分别是 Cloudflare 和 DNSPod。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="cloudflare-例子">Cloudflare 例子<a class="hash-link" href="#cloudflare-例子" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="编写-dockerfile">编写 Dockerfile<a class="hash-link" href="#编写-dockerfile" title="Direct link to heading">​</a></h3><p><code>Dockerfile</code>文件内容如下，用于构建 Docker 镜像。</p><div class="codeBlockContainer_I0IT language-dockerfile theme-code-block"><div class="codeBlockContent_wNvx dockerfile"><pre tabindex="0" class="prism-code language-dockerfile codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">FROM caddy:builder AS builder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN xcaddy build --with github.com/caddy-dns/cloudflare</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FROM caddy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY --from=builder /usr/bin/caddy /usr/bin/caddy</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>每行命令的解释如下。</p><ol><li>使用<code>caddy:builder</code>镜像，起别名为<code>builder</code>，该镜像中包含了<code>go</code>环境和<code>xcaddy</code>工具；</li><li>使用<code>xcaddy</code>来编译<code>caddy</code>，并使用<code>--with</code>参数指定附加的模组，该参数可以重复使用，意味着你可以附加多个模组，这里使用了<code>github.com/caddy-dns/cloudflare</code><sup id="fnref-4"><a href="#fn-4" class="footnote-ref">4</a></sup>；</li><li>使用原版的<code>caddy</code>镜像；</li><li>复制在<code>builder</code>镜像中你自己编译的<code>caddy</code>覆盖掉原版<code>caddy</code>，并使用此镜像作为最终镜像。</li></ol><h3 class="anchor anchorWithStickyNavbar_mojV" id="获取-cloudflare-token">获取 Cloudflare Token<a class="hash-link" href="#获取-cloudflare-token" title="Direct link to heading">​</a></h3><p>在 Cloudflare 的 API Tokens<sup id="fnref-5"><a href="#fn-5" class="footnote-ref">5</a></sup> 页面中创建一个 API Token。</p><p><img alt="image-20220123001758949" src="/assets/images/image-20220123001758949-ce74c7b0467b8a749c0b3a13d5ad77e3.png" width="2204" height="434"></p><p>选择使用编辑 DNS 模板来创建 API Token。</p><p><img alt="image-20220123001847246" src="/assets/images/image-20220123001847246-5a2cc4ab12bfb9156f9ff0b159f2f219.png" width="1476" height="1238"></p><p>在 Zone Resources 中选择目标域名。</p><p><img alt="image-20220123002105447" src="/assets/images/image-20220123002105447-363ec42b463cb88be054fba5bbc94b39.png" width="1866" height="1678"></p><p>确认之后会给你生成一个 Token，你需要保存它。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="编写-caddyfile">编写 Caddyfile<a class="hash-link" href="#编写-caddyfile" title="Direct link to heading">​</a></h3><p><code>Caddyfile</code>文件内容如下，作为 Caddy 的配置文件。</p><div class="codeBlockContainer_I0IT language-caddyfile theme-code-block"><div class="codeBlockContent_wNvx caddyfile"><pre tabindex="0" class="prism-code language-caddyfile codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    email example@gmail.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*.example.com {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tls {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dns cloudflare &lt;CF_API_TOKEN&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @foo host foo.example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    handle @foo {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        reverse_proxy localhost:1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @bar host bar.example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    handle @bar {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        reverse_proxy localhost:2000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    handle {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        abort</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example.com {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reverse_proxy localhost:3000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">foo.bar.example.com {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reverse_proxy localhost:4000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ul><li>1-3：全局配置区块，其中<code>email</code>指定申请证书时用的邮箱，写你自己的邮箱；</li><li>5-23：<code>*.example.com</code>泛域名配置；<ul><li>7：指定 DNS 服务商为 Cloudflare 并且配置 Cloudflare 的 API Token，替换<code>&lt;CF_API_TOKEN&gt;</code>为你自己的；</li><li>10-18：使用具名 Matcher 和<code>handle</code>指令来配置每个使用泛域名证书的站点；</li><li>20-22：其它未定义的域名直接丢弃连接，这需要写在所有站点后面。</li></ul></li><li>25-31：其它不匹配泛域名的域名配置，还和正常使用一样。</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="使用-docker-compose-运行">使用 Docker Compose 运行<a class="hash-link" href="#使用-docker-compose-运行" title="Direct link to heading">​</a></h3><p><code>docker-compose.yml</code>文件内容如下，用于快速运行容器。</p><div class="codeBlockContainer_I0IT language-yml theme-code-block"><div class="codeBlockContent_wNvx yml"><pre tabindex="0" class="prism-code language-yml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;3&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">services</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">caddy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">build</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">restart</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> unless</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">stopped</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">network_mode</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> host</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">volumes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">/data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> ./Caddyfile</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">/etc/caddy/Caddyfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">volumes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  data</span><span class="token punctuation" style="color:#393A34">:</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>当前的目录结构如下。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">caddy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── Dockerfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── Caddyfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── docker-compose.yml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>在 caddy 目录下运行命令。Docker Compose 会根据 Dockerfile 构建镜像并运行。</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">docker-compose up --build -d</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="dnspod-例子">DNSPod 例子<a class="hash-link" href="#dnspod-例子" title="Direct link to heading">​</a></h2><p>和使用 Cloudflare 差不多。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="编写-dockerfile-1">编写 Dockerfile<a class="hash-link" href="#编写-dockerfile-1" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_I0IT language-dockerfile theme-code-block"><div class="codeBlockContent_wNvx dockerfile"><pre tabindex="0" class="prism-code language-dockerfile codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">FROM caddy:builder AS builder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN go env -w GOPROXY=https://goproxy.cn,direct</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN xcaddy build --with github.com/caddy-dns/dnspod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FROM caddy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY --from=builder /usr/bin/caddy /usr/bin/caddy</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>这个 Dockerfile 文件的内容和使用 Cloudfalre 时 Dockerfile 的内容有些许不同。</p><ul><li>第 2 行指定了<code>go get</code>使用国内代理，因为我的这台服务器在国内，在下载依赖的时候遇到了一些网络问题，如果你在使用<code>go get</code>的时候也遇到了网络问题可以试试添加这行命令，在<code>xcaddy build</code>命令之前；</li><li>第 3 行使用<code>xcaddy</code>来编译<code>caddy</code>，并使用<code>--with</code>参数指定附加的模组，该参数可以重复使用，意味着你可以附加多个模组，这里使用了<code>github.com/caddy-dns/dnspod</code><sup id="fnref-6"><a href="#fn-6" class="footnote-ref">6</a></sup>；</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="获取-dnspod-token">获取 DNSPod Token<a class="hash-link" href="#获取-dnspod-token" title="Direct link to heading">​</a></h3><p>在 DNSPod API 密钥页面 <sup id="fnref-7"><a href="#fn-7" class="footnote-ref">7</a></sup> 中生成一个 Token，在生成 Token 之后你需要保存下来，它只会完整地显示一次，以后都不能完整地查看了。</p><p><img alt="image-20220123003832951" src="/assets/images/image-20220123003832951-9150b513dab141de3e1156a1e2dc08ca.png" width="3166" height="640"></p><p>需要注意的是 DNSPod Token 使用时有些不一样，你申请的密钥有 ID 和 Token，在使用时需要把两者组合起来，中间用英文逗号分隔，如<code>&lt;id&gt;,&lt;token&gt;</code>，在使用时你需要将内容替换为自己的 ID 和 Token，更多说明请参考 DNSPod 的 API 使用文档 <sup id="fnref-8"><a href="#fn-8" class="footnote-ref">8</a></sup>。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="编写-caddyfile-1">编写 Caddyfile<a class="hash-link" href="#编写-caddyfile-1" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    email example@gmail.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*.example.com {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tls {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dns dnspod &lt;DNSPOD_TOKEN&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @foo host foo.example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    handle @foo {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        reverse_proxy localhost:1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @bar host bar.example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    handle @bar {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        reverse_proxy localhost:2000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    handle {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        abort</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example.com {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reverse_proxy localhost:3000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">foo.bar.example.com {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reverse_proxy localhost:4000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>第 7 行不一样，指定了 DNS 服务商为<code>dnspod</code>，并且你需要替换掉<code>&lt;DNSPOD_TOKEN&gt;</code>为你自己的。需要注意 DNSPod 的 API Token 格式特殊，是由 ID 和 Token 组合在一起，并用英文逗号分隔。</p><p>其它内容和使用 Cloudflare 时一样，请参考上文。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="使用-docker-compose-运行-1">使用 Docker Compose 运行<a class="hash-link" href="#使用-docker-compose-运行-1" title="Direct link to heading">​</a></h3><p>和使用 Cloudflare 时一样，请参考上文。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="后记">后记<a class="hash-link" href="#后记" title="Direct link to heading">​</a></h2><p>更多使用帮助请参考其官方文档 <sup id="fnref-9"><a href="#fn-9" class="footnote-ref">9</a></sup>，镜像构建出错请查看构建日志，Caddy 运行时出错请查看 Caddy 镜像的日志。</p><div class="footnotes"><hr><ol><li id="fn-1"><a href="https://github.com/caddy-dns" target="_blank" rel="noopener noreferrer">caddy-dns</a><a href="#fnref-1" class="footnote-backref">↩</a></li><li id="fn-2"><a href="https://hub.docker.com/_/caddy" target="_blank" rel="noopener noreferrer">Caddy - Official Image | Docker Hub</a><a href="#fnref-2" class="footnote-backref">↩</a></li><li id="fn-3"><a href="https://github.com/caddyserver/xcaddy" target="_blank" rel="noopener noreferrer">caddyserver/xcaddy: Build Caddy with plugins</a><a href="#fnref-3" class="footnote-backref">↩</a></li><li id="fn-4"><a href="https://github.com/caddy-dns/cloudflare" target="_blank" rel="noopener noreferrer">caddy-dns/cloudflare: Caddy module: dns.providers.cloudflare</a><a href="#fnref-4" class="footnote-backref">↩</a></li><li id="fn-5"><a href="https://dash.cloudflare.com/profile/api-tokens" target="_blank" rel="noopener noreferrer">API Tokens | Cloudflare</a><a href="#fnref-5" class="footnote-backref">↩</a></li><li id="fn-6"><a href="https://github.com/caddy-dns/dnspod" target="_blank" rel="noopener noreferrer">caddy-dns/dnspod</a><a href="#fnref-6" class="footnote-backref">↩</a></li><li id="fn-7"><a href="https://console.dnspod.cn/account/token/token" target="_blank" rel="noopener noreferrer">API 密钥 - DNSPod-免费智能 DNS 解析服务商-电信<em>网通</em>教育网，智能 DNS</a><a href="#fnref-7" class="footnote-backref">↩</a></li><li id="fn-8"><a href="https://docs.dnspod.cn/account/5f2d466de8320f1a740d9ff3/" target="_blank" rel="noopener noreferrer">密钥管理 - DNSPod 服务与支持</a><a href="#fnref-8" class="footnote-backref">↩</a></li><li id="fn-9"><a href="https://caddyserver.com/docs/caddyfile/patterns#wildcard-certificates" target="_blank" rel="noopener noreferrer">Common Caddyfile Patterns — Caddy Documentation</a><a href="#fnref-9" class="footnote-backref">↩</a></li></ol></div></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_h6_j"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/caddy">caddy</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/bobo2334/bobo2334.github.io/edit/master/blog/wildcard-certificates-with-caddy.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/reload-caddyfile-gracefully"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">优雅地重载 Caddyfile</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/mount-tencent-cos-on-local-file-system"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">挂载腾讯云 COS 到本地文件夹</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_cNA8 thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#泛域名证书" class="table-of-contents__link toc-highlight">泛域名证书</a></li><li><a href="#需要做的事情" class="table-of-contents__link toc-highlight">需要做的事情</a></li><li><a href="#cloudflare-例子" class="table-of-contents__link toc-highlight">Cloudflare 例子</a><ul><li><a href="#编写-dockerfile" class="table-of-contents__link toc-highlight">编写 Dockerfile</a></li><li><a href="#获取-cloudflare-token" class="table-of-contents__link toc-highlight">获取 Cloudflare Token</a></li><li><a href="#编写-caddyfile" class="table-of-contents__link toc-highlight">编写 Caddyfile</a></li><li><a href="#使用-docker-compose-运行" class="table-of-contents__link toc-highlight">使用 Docker Compose 运行</a></li></ul></li><li><a href="#dnspod-例子" class="table-of-contents__link toc-highlight">DNSPod 例子</a><ul><li><a href="#编写-dockerfile-1" class="table-of-contents__link toc-highlight">编写 Dockerfile</a></li><li><a href="#获取-dnspod-token" class="table-of-contents__link toc-highlight">获取 DNSPod Token</a></li><li><a href="#编写-caddyfile-1" class="table-of-contents__link toc-highlight">编写 Caddyfile</a></li><li><a href="#使用-docker-compose-运行-1" class="table-of-contents__link toc-highlight">使用 Docker Compose 运行</a></li></ul></li><li><a href="#后记" class="table-of-contents__link toc-highlight">后记</a></li></ul></div></div></div></div></div></div>
<script src="/assets/js/runtime~main.774cf4ed.js"></script>
<script src="/assets/js/main.1ec4401a.js"></script>
</body>
</html>