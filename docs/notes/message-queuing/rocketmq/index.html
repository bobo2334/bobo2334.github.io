<!doctype html>
<html class="docs-version-current" lang="zh-cn" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.9">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="我的学习笔记 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="我的学习笔记 Atom Feed">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" integrity="sha384-Um5gpz1odJg5Z4HAmzPtgZKdTBHZdw8S29IecapCSB31ligYPhHQZMIlWLYQGVoc" crossorigin="anonymous">
<link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180">
<link rel="icon" href="/favicon-32x32.png" sizes="32x32" type="image/png">
<link rel="icon" href="/favicon-16x16.png" sizes="16x16" type="image/png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><title data-react-helmet="true">RocketMQ | 我的学习笔记</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://bobo2334.github.io/docs/notes/message-queuing/rocketmq"><meta data-react-helmet="true" name="docusaurus_locale" content="zh-cn"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" name="msapplication-TileColor" contnet="#da532c"><meta data-react-helmet="true" name="theme-color" contnet="#25c2a0"><meta data-react-helmet="true" property="og:title" content="RocketMQ | 我的学习笔记"><meta data-react-helmet="true" name="description" content="MQ"><meta data-react-helmet="true" property="og:description" content="MQ"><link data-react-helmet="true" rel="shortcut icon" href="/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://bobo2334.github.io/docs/notes/message-queuing/rocketmq"><link data-react-helmet="true" rel="alternate" href="https://bobo2334.github.io/docs/notes/message-queuing/rocketmq" hreflang="zh-cn"><link data-react-helmet="true" rel="alternate" href="https://bobo2334.github.io/docs/notes/message-queuing/rocketmq" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.202caeb0.css">
<link rel="preload" href="/assets/js/runtime~main.67d7c23d.js" as="script">
<link rel="preload" href="/assets/js/main.93cebfe0.js" as="script">
</head>
<body>
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/android-chrome-512x512.png" alt="Logo" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/android-chrome-512x512.png" alt="Logo" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">我的学习笔记</b></a><a class="navbar__item navbar__link" href="/docs/bookmarks/interesting-projects">笔记</a><a class="navbar__item navbar__link" href="/blog/archive">文章</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/bobo2334/bobo2334.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">🌜</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">🌞</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">书签</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">草稿</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">学习笔记</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">c</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">java</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">javascript</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">message-queuing</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/notes/message-queuing/rocketmq">RocketMQ</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">utilities</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>RocketMQ</h1></header><h2 class="anchor anchorWithStickyNavbar_y2LR" id="mq">MQ<a aria-hidden="true" class="hash-link" href="#mq" title="Direct link to heading">​</a></h2><p>MQ（Message Queue，消息队列），是一种 FIFO 的队列。</p><p>它的作用有：</p><ol><li>异步</li><li>解耦</li><li>削峰</li></ol><h2 class="anchor anchorWithStickyNavbar_y2LR" id="rocketmq-介绍">RocketMQ 介绍<a aria-hidden="true" class="hash-link" href="#rocketmq-介绍" title="Direct link to heading">​</a></h2><p>RcoketMQ 是一款低延迟、高可靠、可伸缩、易于使用的消息中间件。</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="nameserver">NameServer<a aria-hidden="true" class="hash-link" href="#nameserver" title="Direct link to heading">​</a></h3><p>注册中心，可以集群。</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="broker">Broker<a aria-hidden="true" class="hash-link" href="#broker" title="Direct link to heading">​</a></h3><p>真正负责消息收发和存储的实体，可以主从。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="单机部署">单机部署<a aria-hidden="true" class="hash-link" href="#单机部署" title="Direct link to heading">​</a></h2><p>可以使用 Docker Compose 来快速部署 RocketMQ。</p><p>RockerMQ 分为 NameServer<sup id="fnref-1"><a href="#fn-1" class="footnote-ref">1</a></sup> 和 Broker<sup id="fnref-2"><a href="#fn-2" class="footnote-ref">2</a></sup>，前者类似于注册中心，后者才是进行存储消息的服务。还有一个第三方服务<code>rocket-mq-console-ng</code><sup id="fnref-3"><a href="#fn-3" class="footnote-ref">3</a></sup><sup id="fnref-4"><a href="#fn-4" class="footnote-ref">4</a></sup>，是 RocketMQ 的网页控制台。</p><p>RocketMQ 的 NameServer 和 Broker 是同一套代码，只是启动的时候参数不一样。<code>apacherocketmq/rocketmq-nameserver</code>和</p><p><code>apacherocketmq/rocketmq-broker</code>在启动参数上有不同。</p><p>RocketMQ 的数据存储在<code>user.home</code>目录下，你可以设置<code>user.home</code>环境变量来自定义存储路径。在这两个 Docker 镜像中，该环境变量的值为<code>/opt</code>。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;3&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">services</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">nameserver</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apacherocketmq/rocketmq</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">nameserver</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">4.5.0</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">alpine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">volumes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> nameserver_logs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">/root/logs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> 9876</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9876</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">environment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">JAVA_OPT_EXT</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot; -Xms128m -Xmx128m -Xmn128m&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> sh mqnamesrv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">broker</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apacherocketmq/rocketmq</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">broker</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">4.5.0</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">alpine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">depends_on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> nameserver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">volumes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> broker_data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">/root/store</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> broker_logs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">/root/logs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> /root/docker</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">compose/rocketmq/broker.conf</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">/home/rocketmq/broker.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> 10909</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">10909</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> 10911</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">10911</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> 10912</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">10912</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">environment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">JAVA_OPT_EXT</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot; -Xms128m -Xmx128m -Xmn128m&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> sh mqbroker </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">c /home/rocketmq/broker.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">console</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apacherocketmq/rocketmq</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">console</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">2.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">depends_on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> nameserver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> broker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> 8088</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">8080</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">environment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">LOGGIN_LEVEL_ROOT</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> info</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">ROCKETMQ_CONFIG_NAMESRVADDR</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nameserver</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9876</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">JAVA_OPTS</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot; -Xms128m -Xmx128m -Xmn128m&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">volumes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">nameserver_logs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">broker_data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  broker_logs</span><span class="token punctuation" style="color:#393A34">:</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>根据上面的文件中的配置内容，你还需要为 Broker 提供配置文件，位于<code>/root/docker-compose/rocketmq/broker.conf</code>。</p><p>需要配置 Broker 的外部 IP，不然客户端连接不上。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">brokerClusterName = DefaultCluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">brokerName = broker-a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">brokerId = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deleteWhen = 04</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fileReservedTime = 48</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">brokerRole = ASYNC_MASTER</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">flushDiskType = ASYNC_FLUSH</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">namesrvAddr=nameserver:9876</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">brokerIP1=192.168.229.129</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">defaultTopicQueueNums=4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">autoCreateTopicEnable=true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">autoCreateSubscriptionGroup=true</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>接着使用<code>docker compose up -d</code>就可以启动容器了，容器名字都会加上当前文件夹名作为前缀。</p><p>可以使用<code>docker compose ps</code>查看容器的运行状态。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="集群部署">集群部署<a aria-hidden="true" class="hash-link" href="#集群部署" title="Direct link to heading">​</a></h2><p>// TODO 还没学，学了再写</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="开发">开发<a aria-hidden="true" class="hash-link" href="#开发" title="Direct link to heading">​</a></h2><p>首先为了使用方便，定义了一些常量。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class MQConstant {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static final String NAMESERVER_ADDR = &quot;192.168.229.129:9876&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="原生-api">原生 API<a aria-hidden="true" class="hash-link" href="#原生-api" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_y2LR" id="消费者推送">消费者（推送）<a aria-hidden="true" class="hash-link" href="#消费者推送" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">package example.sync;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Consumer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static final String CONSUMER_GROUP = &quot;sync_message_consumer&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DefaultMQPushConsumer consumer = new DefaultMQPushConsumer(CONSUMER_GROUP);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        consumer.setNamesrvAddr(MQConstant.NAMESERVER_ADDR);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        consumer.setConsumeFromWhere(ConsumeFromWhere.CONSUME_FROM_LAST_OFFSET);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        consumer.subscribe(MQTopicConstant.PRACTISE, MQTagConstant.PRACTISE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        consumer.registerMessageListener((MessageListenerOrderly) (msgs, context) -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            msgs.forEach(messageExt -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                log.info(&quot;收到消息：{}&quot;, messageExt);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                log.info(&quot;消息体：{}&quot;, new String(messageExt.getBody()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return ConsumeOrderlyStatus.SUCCESS;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        consumer.start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log.info(&quot;Consumer 已启动&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Runtime.getRuntime().addShutdownHook(new Thread(() -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            log.info(&quot;程序正在退出&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            consumer.shutdown();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_y2LR" id="生产者同步发送">生产者（同步发送）<a aria-hidden="true" class="hash-link" href="#生产者同步发送" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">package example.sync;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Producer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static final String PRODUCER_GROUP = &quot;sync_message_producer&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DefaultMQProducer producer = new DefaultMQProducer(PRODUCER_GROUP);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        producer.setNamesrvAddr(MQConstant.NAMESERVER_ADDR);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        producer.start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Stream.generate(RandomUtil::randomInt)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .limit(10)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(i -&gt; new Message(MQTopicConstant.PRACTISE, MQTagConstant.PRACTISE, StrUtil.format(&quot;Hello RocketMQ: {}&quot;, i).getBytes(StandardCharsets.UTF_8)))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .forEach(message -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        SendResult result = producer.send(message, 10000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        log.info(&quot;消息已发送：{}&quot;, result);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        log.error(&quot;消息发送失败&quot;, e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        producer.shutdown();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_y2LR" id="生产者异步发送">生产者（异步发送）<a aria-hidden="true" class="hash-link" href="#生产者异步发送" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">package example.producer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class AsyncMessageProducer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static final String PRODUCER_GROUP = &quot;async_message_producer&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final int count = 10;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DefaultMQProducer producer = new DefaultMQProducer(PRODUCER_GROUP);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        producer.setNamesrvAddr(MQConstant.NAMESERVER_ADDR);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        producer.start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        CountDownLatch countDownLatch = new CountDownLatch(count);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Stream.generate(RandomUtil::randomInt)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .limit(count)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(i -&gt; new Message(MQTopicConstant.PRACTISE, MQTagConstant.PRACTISE, StrUtil.format(&quot;Hello RocketMQ: {}&quot;, i).getBytes(StandardCharsets.UTF_8)))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .forEach(message -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        producer.send(message, new SendCallback() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            public void onSuccess(SendResult sendResult) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                log.info(&quot;消息发送成功：{}&quot;, sendResult);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                countDownLatch.countDown();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            public void onException(Throwable e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                log.error(&quot;消息发送失败&quot;, e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                countDownLatch.countDown();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        log.info(&quot;消息已发送：{}&quot;, message);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        log.error(&quot;消息发送失败&quot;, e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        countDownLatch.await();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        producer.shutdown();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_y2LR" id="生产者单向发送">生产者（单向发送）<a aria-hidden="true" class="hash-link" href="#生产者单向发送" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// org.apache.rocketmq.client.producer.DefaultMQProducer#sendOneway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void sendOneway(Message msg)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_y2LR" id="消费者拉取">消费者（拉取）<a aria-hidden="true" class="hash-link" href="#消费者拉取" title="Direct link to heading">​</a></h4><p>主动拉取可以更灵活地消费消息。</p><p>// TODO 还需要明白主动拉取后的消费确认机制</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">package example.consumer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class PullConsumer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static final String CONSUMER_GROUP = &quot;pull_message_consumer&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DefaultLitePullConsumer consumer = new DefaultLitePullConsumer(CONSUMER_GROUP);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        consumer.setConsumeFromWhere(ConsumeFromWhere.CONSUME_FROM_LAST_OFFSET);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        consumer.setNamesrvAddr(MQConstant.NAMESERVER_ADDR);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        consumer.subscribe(MQTopicConstant.PRACTISE, MQTagConstant.ALL);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        consumer.start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while (true) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;MessageExt&gt; messages = consumer.poll();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (CollUtil.isEmpty(messages)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            messages.forEach(messageExt -&gt; log.info(&quot;收到消息：{}&quot;, messageExt));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Runtime.getRuntime().addShutdownHook(new Thread(consumer::shutdown));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_y2LR" id="顺序消费">顺序消费<a aria-hidden="true" class="hash-link" href="#顺序消费" title="Direct link to heading">​</a></h4><p>顺序消费要做到需要顺序消费的一组消息都发送到同一个队列上。消费者在消费的时候使用串行消费而不是并发消费。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// org.apache.rocketmq.client.producer.DefaultMQProducer#send</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public SendResult send(Message msg, MessageQueueSelector selector, Object arg)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>MessageQueueSelector</code>可以选择发送消息到哪个队列上。</p><p>在实际使用中，可以动态地选择队列来实现负载均衡，只要保证需要顺序消费的同一组消息发送到同一个队列上即可。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">SendResult sendResult = producer.send(message, (mqs, msg, arg) -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    int i = (Integer) arg % mqs.size();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return mqs.get(i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }, pair.getKey());</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_y2LR" id="广播消息">广播消息<a aria-hidden="true" class="hash-link" href="#广播消息" title="Direct link to heading">​</a></h4><p>默认情况下，同一个消费者组在消费消息时有竞争关系。在消费消息的时候设置消费者为广播模式就可以让消费者去掉竞争属性。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// org.apache.rocketmq.client.consumer.DefaultMQPushConsumer#setMessageModel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void setMessageModel(MessageModel messageModel)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>MessageModel</code>默认为<code>CLUSTERING</code>，需要设置为<code>BROADCASTING</code>。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">consumer.setMessageModel(MessageModel.BROADCASTING);</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_y2LR" id="延迟消息">延迟消息<a aria-hidden="true" class="hash-link" href="#延迟消息" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// org.apache.rocketmq.common.message.Message#setDelayTimeLevel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void setDelayTimeLevel(int level)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>可以给<code>Message</code>设置<code>delayLevel</code>，延迟级别分别为<code>1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h</code>，从 1 开始数。</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="批量消息">批量消息<a aria-hidden="true" class="hash-link" href="#批量消息" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// org.apache.rocketmq.client.producer.DefaultMQProducer#send</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public SendResult send(Collection&lt;Message&gt; msgs)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>可以简单地把消息封装为<code>Collection&lt;Message&gt;</code>，一起发出去。</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="过滤消息">过滤消息<a aria-hidden="true" class="hash-link" href="#过滤消息" title="Direct link to heading">​</a></h4><p>大多数情况下，可以通过 Topic 和 Tag 来过滤消息。</p><p>Tag 可以用表达式写。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">consumer.subscribe(MQTopicConstant.PRACTISE, MessageSelector.byTag(&quot;TAG&quot;));</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>在复杂情况下，还可以通过 SQL 语句来过滤消息。</p><p><img alt="image-20210808203938656" src="/assets/images/image-20210808203938656-16284263806451-7f89deb7e411d26cee0f7df6201228d8.png"></p><p>其中变量<code>a</code>可以在发送消息的时候通过<code>putUserProperty()</code>放入。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// org.apache.rocketmq.common.message.Message#putUserProperty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void putUserProperty(final String name, final String value)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>只有推送模式的 Consumer 可以使用消息过滤。</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="事务消息">事务消息<a aria-hidden="true" class="hash-link" href="#事务消息" title="Direct link to heading">​</a></h4><p><img alt="image-20210808210014135" src="/assets/images/image-20210808210014135-b1531c7018ce5af37f983e4f3d4116fe.png"></p><p>事务消息的机制是在发送消息时会发送一个办消息，这个消息存放在系统创建的 Topic 中，对消费者是不可见的。在生产者对消息进行提交之后才会把消息转移到目标 Topic。如果生产者没有对消息进行提交，RocketMQ 会每隔一段时间进行回查，确认本地事务是否已提交成功，如果是则把消息转移到目标 Topic，否则若超过最大回查尝试次数则丢弃消息，默认最大重试次数为 15。</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="spring-boot">Spring Boot<a aria-hidden="true" class="hash-link" href="#spring-boot" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_y2LR" id="配置">配置<a aria-hidden="true" class="hash-link" href="#配置" title="Direct link to heading">​</a></h4><p>配置解耦，写在配置文件中。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">rocketmq.name-server=192.168.229.129:9876</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rocketmq.producer.group=spring-boot-producer-group</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_y2LR" id="生产者同步发送-1">生产者（同步发送）<a aria-hidden="true" class="hash-link" href="#生产者同步发送-1" title="Direct link to heading">​</a></h4><p>核心是<code>RocketMQTemplate</code>，消息的发送都依赖它完成。<code>RocketMQTemplate</code>已经在 Spring 容器中，可以自动注入拿到。其中<code>destination</code>的格式为<code>${topic}:${tag}</code>。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// org.springframework.messaging.core.AbstractMessageSendingTemplate#send</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void send(D destination, Message&lt;?&gt; message)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>发送消息用<code>send()</code>，参数中的<code>Message</code>实际上是<code>org.springframework.messaging.Message</code>，而不是<code>org.apache.rocketmq.common.message.Message</code>。</p><p><code>Message</code>可以用<code>MessageBuilder</code>构建。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">MessageBuilder.withPayload(payload).build();</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_y2LR" id="生产者异步发送-1">生产者（异步发送）<a aria-hidden="true" class="hash-link" href="#生产者异步发送-1" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// org.apache.rocketmq.spring.core.RocketMQTemplate#asyncSend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void asyncSend(String destination, Message&lt;?&gt; message, SendCallback sendCallback)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_y2LR" id="生产者单向发送-1">生产者（单向发送）<a aria-hidden="true" class="hash-link" href="#生产者单向发送-1" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// org.apache.rocketmq.spring.core.RocketMQTemplate#sendOneWay</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void sendOneWay(String destination, Message&lt;?&gt; message)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_y2LR" id="消费者推送-1">消费者（推送）<a aria-hidden="true" class="hash-link" href="#消费者推送-1" title="Direct link to heading">​</a></h4><p>消息的消费有了新的抽象。只需实现<code>RocketMQListener</code>接口就可以快速完成消息消费。设计原则是一个接口消费一种消息，如果需要消费其他消息则需要多个接口。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">package com.example.rocketmqinspringboot.listener;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@RocketMQMessageListener(consumerGroup = MQConstant.CONSUMER_GROUP, topic = MQTopicConstant.PRACTISE, selectorExpression = MQTagConstant.PRACTISE)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Consumer implements RocketMQListener&lt;String&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onMessage(String message) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log.info(&quot;收到消息：{}&quot;, message);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>上面的例子会直接拿到消息中的 Payload 并且将之转为泛型对应类型的对象。如果你需要拿到消息的头部信息，把泛型设置为<code>MessageExt</code>，其中可以拿到头部信息 <sup id="fnref-5"><a href="#fn-5" class="footnote-ref">5</a></sup>。</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="顺序消费-1">顺序消费<a aria-hidden="true" class="hash-link" href="#顺序消费-1" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// org.apache.rocketmq.spring.core.RocketMQTemplate#sendAndReceive</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public &lt;T&gt; T sendAndReceive(String destination, Message&lt;?&gt; message, Type type, String hashKey)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>生产者同一组消息指定相同的<code>hashKey</code>，则该组消息会被发送到同一个消息队列上。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// org.apache.rocketmq.spring.annotation.RocketMQMessageListener#consumeMode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ConsumeMode consumeMode() default ConsumeMode.CONCURRENTLY;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>消费者把<code>consumeMode</code>设置为<code>ORDERLY</code>。</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="广播消息-1">广播消息<a aria-hidden="true" class="hash-link" href="#广播消息-1" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// org.apache.rocketmq.spring.annotation.RocketMQMessageListener#messageModel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MessageModel messageModel() default MessageModel.CLUSTERING;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_y2LR" id="过滤消息-1">过滤消息<a aria-hidden="true" class="hash-link" href="#过滤消息-1" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// org.apache.rocketmq.spring.annotation.RocketMQMessageListener#selectorType</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SelectorType selectorType() default SelectorType.TAG;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// org.apache.rocketmq.spring.annotation.RocketMQMessageListener#selectorExpression</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">String selectorExpression() default &quot;*&quot;;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_y2LR" id="事务消息-1">事务消息<a aria-hidden="true" class="hash-link" href="#事务消息-1" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// org.apache.rocketmq.spring.core.RocketMQTemplate#sendMessageInTransaction</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public TransactionSendResult sendMessageInTransaction(final String destination, final Message&lt;?&gt; message, final Object arg)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>发送事务消息依赖<code>sendMessageInTransaction</code>完成。<code>arg</code>作为自定义参数会被传递到<code>RocketMQLocalTransactionListener#executeLocalTransaction</code>中，本地事务逻辑会在该方法中完成。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">package com.example.rocketmqinspringboot.controller;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Operation(summary = &quot;发事务消息&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@PostMapping(&quot;/transaction&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void sendTransactionMessage(@RequestBody String message) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TransactionSendResult transactionSendResult = rocketMQTemplate.sendMessageInTransaction(getDestination(), getMessage(message), message);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log.info(&quot;transactionSendResult: {}&quot;, transactionSendResult);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">package com.example.rocketmqinspringboot.listener;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@RocketMQTransactionListener</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class TransactionListener implements RocketMQLocalTransactionListener {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public RocketMQLocalTransactionState executeLocalTransaction(Message msg, Object arg) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String orderNumber = new String((byte[]) msg.getPayload());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log.info(&quot;执行事务，{}&quot;, orderNumber);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return RocketMQLocalTransactionState.UNKNOWN;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public RocketMQLocalTransactionState checkLocalTransaction(Message msg) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String orderNumber = new String((byte[]) msg.getPayload());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log.info(&quot;回查，{}&quot;, orderNumber);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return RocketMQLocalTransactionState.COMMIT;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>发送事务消息时，一个<code>RocketMQTemplate</code>对应一个<code>RocketMQLocalTransactionListener</code>，该<code>RocketMQTemplate</code>所发出的事务消息都会在对应的<code>RocketMQLocalTransactionListener</code>中执行。</p><p>如果需要定义多个事务消息监听器，就需要多个<code>RocketMQListener</code>，对应多个<code>RocketMQLocalTransactionListener</code>。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">package com.example.rocketmqinspringboot.config;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@ExtRocketMQTemplateConfiguration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ExtRocketMQTemplate extends RocketMQTemplate {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">package com.example.rocketmqinspringboot.listener;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@RocketMQTransactionListener(rocketMQTemplateBeanName = &quot;extRocketMQTemplate&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ExtTransactionListener implements RocketMQLocalTransactionListener {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public RocketMQLocalTransactionState executeLocalTransaction(Message msg, Object arg) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return RocketMQLocalTransactionState.UNKNOWN;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public RocketMQLocalTransactionState checkLocalTransaction(Message msg) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return RocketMQLocalTransactionState.COMMIT;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="spring-cloud-stream">Spring Cloud Stream<a aria-hidden="true" class="hash-link" href="#spring-cloud-stream" title="Direct link to heading">​</a></h3><p>Spring Cloud Stream 是 Spring 官方提供的一个针对所有开源的消息系统进行统一封装。</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="配置-1">配置<a aria-hidden="true" class="hash-link" href="#配置-1" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">package com.example.rocketmqspringcloudstream;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@EnableBinding({Source.class, Sink.class})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@SpringBootApplication</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class RocketmqSpringCloudStreamApplication {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SpringApplication.run(RocketmqSpringCloudStreamApplication.class, args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>Source</code>和<code>Sink</code>是 Spring Cloud Stream 提供的简单的消息输入和输出通道。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">spring.cloud.stream.bindings.input.destination=STREAM_TOPIC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring.cloud.stream.bindings.input.group=STREAM_GROUP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring.cloud.stream.bindings.output.destination=STREAM_TOPIC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring.cloud.stream.rocketmq.binder.name-server=192.168.229.129:9876</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Spring Cloud Stream 关于消息生产和消费的配置都放在配置文件中。</p><p><code>spring.cloud.stream.bindings</code>是一个<code>Map</code>，可以配置多个通道，<code>input</code>就是<code>Sink</code>的通道名，<code>output</code>就是<code>Source</code>的通道名。</p><p>如果需要定义其他通道就新增配置文件，然后新增类似于<code>Sink</code>和<code>Sourec</code>的接口。</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="生产者">生产者<a aria-hidden="true" class="hash-link" href="#生产者" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">package com.example.rocketmqspringcloudstream.controller;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Tag(name = &quot;消息&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/messages&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MessageController {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Source source;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Operation(summary = &quot;发同步消息&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PostMapping(&quot;/sync&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void sendSync(@RequestBody String message) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Map&lt;String, Object&gt; headers = new HashMap&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        headers.put(MessageConst.PROPERTY_TAGS, MQTagConstant.PRACTISE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Message&lt;String&gt; msg = MessageBuilder.createMessage(message, new MessageHeaders(headers));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        boolean success = source.output().send(msg);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log.info(&quot;success: {}&quot;, success);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_y2LR" id="消费者">消费者<a aria-hidden="true" class="hash-link" href="#消费者" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">package com.example.rocketmqspringcloudstream.consumer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Consumer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @StreamListener(Sink.INPUT)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void consume(String message) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log.info(&quot;收到消息：{}&quot;, message);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="参考资料">参考资料<a aria-hidden="true" class="hash-link" href="#参考资料" title="Direct link to heading">​</a></h2><ol><li><a href="https://www.bilibili.com/video/BV1h54y1H7YF" target="_blank" rel="noopener noreferrer">2021 年 B 站讲的最牛掰的 RocketMQ 分布式消息中间件：核心原理与最佳实践_哔哩哔哩_bilibili</a></li><li><a href="http://rocketmq.apache.org/" target="_blank" rel="noopener noreferrer">Apache RocketMQ</a></li><li><a href="https://github.com/apache/rocketmq/tree/master/docs/cn" target="_blank" rel="noopener noreferrer">rocketmq/docs/cn at master · apache/rocketmq</a></li><li><a href="https://github.com/apache/rocketmq-externals/tree/master/rocketmq-console" target="_blank" rel="noopener noreferrer">rocketmq-externals/rocketmq-console at master · apache/rocketmq-externals</a></li><li><a href="https://www.jianshu.com/p/706588323276" target="_blank" rel="noopener noreferrer">基于 Docker 安装 RocketMQ - 简书</a></li><li><a href="https://github.com/apache/rocketmq-docker/blob/master/templates/docker-compose/docker-compose.yml" target="_blank" rel="noopener noreferrer">rocketmq-docker/docker-compose.yml at master · apache/rocketmq-docker</a></li><li><a href="https://github.com/apache/rocketmq-spring/wiki/%E7%94%A8%E6%88%B7%E6%89%8B%E5%86%8C" target="_blank" rel="noopener noreferrer">用户手册 · apache/rocketmq-spring Wiki</a></li></ol><div class="footnotes"><hr><ol><li id="fn-1"><a href="https://hub.docker.com/r/apacherocketmq/rocketmq-nameserver" target="_blank" rel="noopener noreferrer">apacherocketmq/rocketmq-nameserver - Docker Image | Docker Hub</a><a href="#fnref-1" class="footnote-backref">↩</a></li><li id="fn-2"><a href="https://hub.docker.com/r/apacherocketmq/rocketmq-broker" target="_blank" rel="noopener noreferrer">apacherocketmq/rocketmq-broker - Docker Image | Docker Hub</a><a href="#fnref-2" class="footnote-backref">↩</a></li><li id="fn-3"><a href="https://hub.docker.com/r/apacherocketmq/rocketmq-console" target="_blank" rel="noopener noreferrer">apacherocketmq/rocketmq-console - Docker Image | Docker Hub</a><a href="#fnref-3" class="footnote-backref">↩</a></li><li id="fn-4"><a href="https://github.com/apache/rocketmq-externals/tree/master/rocketmq-console" target="_blank" rel="noopener noreferrer">rocketmq-externals/rocketmq-console at master · apache/rocketmq-externals</a><a href="#fnref-4" class="footnote-backref">↩</a></li><li id="fn-5"><a href="https://github.com/apache/rocketmq-spring/wiki/%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98" target="_blank" rel="noopener noreferrer">常见问题 · apache/rocketmq-spring Wiki</a><a href="#fnref-5" class="footnote-backref">↩</a></li></ol></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/notes/javascript/weapp"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« <!-- -->微信小程序</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/notes/utilities/editorconfig"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">EditorConfig<!-- --> »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#mq" class="table-of-contents__link toc-highlight">MQ</a></li><li><a href="#rocketmq-介绍" class="table-of-contents__link toc-highlight">RocketMQ 介绍</a><ul><li><a href="#nameserver" class="table-of-contents__link toc-highlight">NameServer</a></li><li><a href="#broker" class="table-of-contents__link toc-highlight">Broker</a></li></ul></li><li><a href="#单机部署" class="table-of-contents__link toc-highlight">单机部署</a></li><li><a href="#集群部署" class="table-of-contents__link toc-highlight">集群部署</a></li><li><a href="#开发" class="table-of-contents__link toc-highlight">开发</a><ul><li><a href="#原生-api" class="table-of-contents__link toc-highlight">原生 API</a><ul><li><a href="#消费者推送" class="table-of-contents__link toc-highlight">消费者（推送）</a></li><li><a href="#生产者同步发送" class="table-of-contents__link toc-highlight">生产者（同步发送）</a></li><li><a href="#生产者异步发送" class="table-of-contents__link toc-highlight">生产者（异步发送）</a></li><li><a href="#生产者单向发送" class="table-of-contents__link toc-highlight">生产者（单向发送）</a></li><li><a href="#消费者拉取" class="table-of-contents__link toc-highlight">消费者（拉取）</a></li><li><a href="#顺序消费" class="table-of-contents__link toc-highlight">顺序消费</a></li><li><a href="#广播消息" class="table-of-contents__link toc-highlight">广播消息</a></li><li><a href="#延迟消息" class="table-of-contents__link toc-highlight">延迟消息</a></li><li><a href="#批量消息" class="table-of-contents__link toc-highlight">批量消息</a></li><li><a href="#过滤消息" class="table-of-contents__link toc-highlight">过滤消息</a></li><li><a href="#事务消息" class="table-of-contents__link toc-highlight">事务消息</a></li></ul></li><li><a href="#spring-boot" class="table-of-contents__link toc-highlight">Spring Boot</a><ul><li><a href="#配置" class="table-of-contents__link toc-highlight">配置</a></li><li><a href="#生产者同步发送-1" class="table-of-contents__link toc-highlight">生产者（同步发送）</a></li><li><a href="#生产者异步发送-1" class="table-of-contents__link toc-highlight">生产者（异步发送）</a></li><li><a href="#生产者单向发送-1" class="table-of-contents__link toc-highlight">生产者（单向发送）</a></li><li><a href="#消费者推送-1" class="table-of-contents__link toc-highlight">消费者（推送）</a></li><li><a href="#顺序消费-1" class="table-of-contents__link toc-highlight">顺序消费</a></li><li><a href="#广播消息-1" class="table-of-contents__link toc-highlight">广播消息</a></li><li><a href="#过滤消息-1" class="table-of-contents__link toc-highlight">过滤消息</a></li><li><a href="#事务消息-1" class="table-of-contents__link toc-highlight">事务消息</a></li></ul></li><li><a href="#spring-cloud-stream" class="table-of-contents__link toc-highlight">Spring Cloud Stream</a><ul><li><a href="#配置-1" class="table-of-contents__link toc-highlight">配置</a></li><li><a href="#生产者" class="table-of-contents__link toc-highlight">生产者</a></li><li><a href="#消费者" class="table-of-contents__link toc-highlight">消费者</a></li></ul></li></ul></li><li><a href="#参考资料" class="table-of-contents__link toc-highlight">参考资料</a></li></ul></div></div></div></div></main></div></div></div>
<script src="/assets/js/runtime~main.67d7c23d.js"></script>
<script src="/assets/js/main.93cebfe0.js"></script>
</body>
</html>